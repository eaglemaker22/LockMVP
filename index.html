<script>
  // Fetch the latest data for the top dashboard
  fetch('/.netlify/functions/getTopDashboardData')
    .then(response => response.json()) 
    .then(data => {
      // Update UMBS 5.5 (Live)
      let item = data.UMBS_5_5;
      let changeVal = item.change !== null ? parseFloat(item.change) : 0;
      let changeStr = item.change === null ? "0.00" : item.change;
      if (changeVal > 0) { 
        changeStr = "+" + changeStr;            // prepend '+' for positive
        document.getElementById('box-umbs-live').classList.remove('bg-gray-200');
        document.getElementById('box-umbs-live').classList.add('bg-red-200');
      } else if (changeVal < 0) {
        // negative change (string already contains '-')
        document.getElementById('box-umbs-live').classList.remove('bg-gray-200');
        document.getElementById('box-umbs-live').classList.add('bg-green-200');
      }
      // Determine current value (UMBS uses 'current')
      let currentVal = item.current || item.yield;
      // Format and insert text
      document.getElementById('umbs-live-value').textContent = `${changeStr} | ${currentVal}`;
      // Format timestamp to local time
      let updatedTime = new Date(item.last_updated);  // create Date object from timestamp
      let timeString = updatedTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      document.getElementById('umbs-live-updated').textContent = `Updated: ${timeString}`;
      
      // Update UMBS 5.5 (Shadow)
      item = data.UMBS_5_5_Shadow;
      changeVal = item.change !== null ? parseFloat(item.change) : 0;
      changeStr = item.change === null ? "0.00" : item.change;
      if (changeVal > 0) {
        changeStr = "+" + changeStr;
        document.getElementById('box-umbs-shadow').classList.remove('bg-gray-200');
        document.getElementById('box-umbs-shadow').classList.add('bg-red-200');
      } else if (changeVal < 0) {
        document.getElementById('box-umbs-shadow').classList.remove('bg-gray-200');
        document.getElementById('box-umbs-shadow').classList.add('bg-green-200');
      }
      let shadowVal = item.current || item.yield;
      document.getElementById('umbs-shadow-value').textContent = `${changeStr} | ${shadowVal}`;
      updatedTime = new Date(item.last_updated);
      timeString = updatedTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      document.getElementById('umbs-shadow-updated').textContent = `Updated: ${timeString}`;
      
      // Update US10Y
      item = data.US10Y;
      changeVal = item.change !== null ? parseFloat(item.change) : 0;
      changeStr = item.change === null ? "0.00" : item.change;
      if (changeVal > 0) {
        changeStr = "+" + changeStr;
        document.getElementById('box-us10y').classList.remove('bg-gray-200');
        document.getElementById('box-us10y').classList.add('bg-red-200');
      } else if (changeVal < 0) {
        document.getElementById('box-us10y').classList.remove('bg-gray-200');
        document.getElementById('box-us10y').classList.add('bg-green-200');
      }
      // US10Y uses 'yield' field for the value
      let us10yVal = item.current || item.yield;
      document.getElementById('us10y-value').textContent = `${changeStr} | ${us10yVal}`;
      updatedTime = new Date(item.last_updated);
      timeString = updatedTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      document.getElementById('us10y-updated').textContent = `Updated: ${timeString}`;
      
      // Update US30Y
      item = data.US30Y;
      changeVal = item.change !== null ? parseFloat(item.change) : 0;
      changeStr = item.change === null ? "0.00" : item.change;
      if (changeVal > 0) {
        changeStr = "+" + changeStr;
        document.getElementById('box-us30y').classList.remove('bg-gray-200');
        document.getElementById('box-us30y').classList.add('bg-red-200');
      } else if (changeVal < 0) {
        document.getElementById('box-us30y').classList.remove('bg-gray-200');
        document.getElementById('box-us30y').classList.add('bg-green-200');
      }
      let us30yVal = item.current || item.yield;
      document.getElementById('us30y-value').textContent = `${changeStr} | ${us30yVal}`;
      updatedTime = new Date(item.last_updated);
      timeString = updatedTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      document.getElementById('us30y-updated').textContent = `Updated: ${timeString}`;
    })
    .catch(error => {
      console.error('Error fetching top dashboard data:', error);
    });
</script>
